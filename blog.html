<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ぶどう日誌｜ながたぶどう園</title>

  <meta name="description" content="ながたぶどう園の『ぶどう日誌』。畑のようす・栽培メモ・収穫の裏側などを記録しています。" />
  <meta name="theme-color" content="#5b7a59" />

  <!-- OGP -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ぶどう日誌｜ながたぶどう園" />
  <meta property="og:description" content="畑のようす・栽培メモ・収穫の裏側など。" />
  <meta property="og:image" content="assets/img/ogp.png" />
  <meta property="og:url" content="https://example.jp/blog.html" />

  <link rel="icon" href="assets/img/ogp.png" />
  <link rel="stylesheet" href="assets/css/style.css" />

  <!-- index.html と同じ /exec URL を入れてください -->
  <script type="application/json" id="cfg-json">
  { "webAppUrl": "https://script.google.com/macros/s/AKfycbzNyMIKzfIkhW4jrLIeicETHuwHhLWqJAOPPA0RlNhMGXfxFoTTNV8mNDtYMBWbc7Eg/exec" }
  </script>

  <!-- blog.html 専用：読みやすさ最優先のCSS（置き換え用） -->
  <style>
    /* ========== ヒーロー（小さく・高コントラスト） ========== */
    .page-hero{
      padding: 12px 0 8px;
      background:#cce0cf;
      border-bottom:1px solid #e9ece8;
    }
    .page-hero .hero__content{ max-width:880px; margin:0 auto; }
    .page-hero .kicker{
      display:inline-block; margin-bottom:6px; padding:2px 8px;
      border-radius:10px; font-weight:600;
      color:#31513a; background:#e9f1ea; font-size:.85rem;
    }
    .page-hero h1{
      margin:0; line-height:1.25;
      font-size:clamp(22px, 2.8vw, 28px);
      color:#1f2a1f;
    }
    .page-hero .section-lead{
      margin:6px 0 0; color:#2e3a2e;
      font-size:clamp(14px, 1.7vw, 16px);
    }
  
    /* ========== ツールバー（検索・もっと見る） ========== */
    .blog-toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 0; }
    .blog-search{
      flex:1 1 260px; max-width:460px;
      padding:.6em .9em; border:1px solid #cfd6cf; border-radius:12px;
      background:#fff; color:#222;
    }
    .blog-search::placeholder{ color:#96a197; }
    .blog-search:focus{ outline:0; box-shadow:0 0 0 3px rgba(91,122,89,.18); }
    #loadMoreBtn.btn{ padding:.55em 1em; }
  
    /* ========== 一覧カード（読みやすい比率・濃い文字） ========== */
    #blogList{ gap:16px; }
    #blogList .card.post{
      display:grid; grid-template-columns:1fr; gap:10px;
      padding:12px; border-radius:14px;
    }
    #blogList .card.post img{
      width:100%; height:160px; object-fit:cover; border-radius:12px;
    }
    @media (min-width:700px){
      #blogList .card.post{ grid-template-columns:44% 1fr; align-items:stretch; }
      #blogList .card.post img{ height:100%; }
    }
    #blogList .card.post h4{
      margin:0 0 6px;
      font-size:clamp(16px, 1.9vw, 18px);
      color:#1f2a1f; line-height:1.45;
    }
    #blogList .card.post time{
      display:block; margin-bottom:4px;
      font-size:.9em; color:#6b746c;
    }
    #blogList .card.post p{
      color:#263126; font-size:.975rem; line-height:1.7;
    }
    #blogList .card.post .btn{ margin-top:8px; }
  
    /* ========== 安全網（他CSSの色上書きを無効化） ========== */
    :root{ color-scheme:light; }
    body, .container{ color:#222; }              /* 全体の基本色を濃く */

    /* ===== 見えない対策（最小） ※追加はこの1行だけ ===== */
    .card.post .btn{ display:inline-block !important; visibility:visible !important; }
    /* 一覧は常に1列（スマホ～PCまで統一） */
    #blogList.grid.grid-3{ grid-template-columns: 1fr !important; }
    @media (min-width:760px){
      #blogList.grid.grid-3{ grid-template-columns: 1fr !important; }
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">本文へスキップ</a>

  <!-- ===== ヘッダー ===== -->
  <header class="site-header" role="banner">
    <div class="bar">
      <div class="inner">
        <h1 class="brand" aria-label="ながたぶどう園">
          <svg class="brand__logo" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <circle cx="9" cy="8" r="3" fill="#fff" opacity="0.9"/>
            <circle cx="14.5" cy="6.5" r="2.3" fill="#fff" opacity="0.85"/>
            <circle cx="13" cy="10.5" r="2.6" fill="#fff" opacity="0.92"/>
            <path d="M15 3c2 .3 2.8 1.4 3.3 2.4" stroke="#fff" stroke-width="1.2" fill="none" stroke-linecap="round"/>
          </svg>
          <span class="brand__name">ながたぶどう園</span>
        </h1>

        <button class="nav-toggle" id="navToggle" aria-label="メニュー" aria-controls="primaryNav" aria-expanded="false">
          <span class="nav-toggle__bar" aria-hidden="true"></span>
        </button>

        <nav class="primary" id="primaryNav" role="navigation" aria-label="主なメニュー">
          <a href="index.html">ホーム</a>
          <a class="shop.html">注文する</a>
          <a href="gift.html">ギフト</a>
          <a href="calendar.html">収穫カレンダー</a>
          <a href="guide.html">はじめての方</a>
          <a href="news.html">最新情報</a>
          <a class="is-active" href="blog.html" aria-current="page">ぶどう日誌</a>
          <a href="about.html">農園紹介</a>
          <a href="contact.html">お問い合わせ</a>
        </nav>
      </div>
    </div>
  </header>

  <main id="main">
    <!-- ===== ページ見出し（小さめ） ===== -->
    <section class="section page-hero reveal" aria-label="ぶどう日誌ヒーロー">
      <div class="container hero__content">
        <span class="kicker">Farm Blog</span>
        <h1>ぶどう日誌</h1>
        <p class="section-lead">畑のようす、栽培メモ、収穫の裏側などを綴ります。</p>

        <div class="blog-toolbar">
          <input id="blogSearch" class="blog-search" type="search" placeholder="記事を検索（例：摘粒・剪定・シャインマスカット）" aria-label="記事を検索">
          <button id="loadMoreBtn" class="btn">もっと見る</button>
        </div>
      </div>
    </section>

    <!-- ===== 一覧 ===== -->
    <section class="section reveal" aria-label="ぶどう日誌一覧">
      <div class="container">
        <div id="blogList" class="grid grid-3" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <!-- ===== フッター ===== -->
  <footer role="contentinfo">
    <div class="container footer-inner">
      <div>
        <h3 class="footer-title">ながたぶどう園</h3>
        <p>長野県須坂市 日滝原</p>
        <p>お問い合わせ：<a href="mailto:info@example.jp">info@example.jp</a></p>
        <p>Instagram / YouTube / LINE 公式</p>
      </div>
      <div>
        <p>営業時間：9:00-17:00（季節により変動）</p>
        <p>※ 畑作業でお電話に出られない場合があります。メールでのご連絡が確実です。</p>
        <p><a href="law.html">特定商取引法に基づく表記</a> ／ <a href="privacy.html">プライバシーポリシー</a></p>
      </div>
      <div class="copyright">© 2025 ながたぶどう園</div>
    </div>
  </footer>

  <script src="assets/js/main.js"></script>

  <!-- ===== ぶどう日誌の取得＆表示 ===== -->
  <script>
  (async () => {
    const cfg = (() => { try { return JSON.parse(document.getElementById('cfg-json')?.textContent || '{}'); } catch(_) { return {}; } })();
    const listEl = document.getElementById('blogList');
    const btn    = document.getElementById('loadMoreBtn');
    const q      = document.getElementById('blogSearch');

    const FETCH_LIMIT = 200;  // 取得最大
    const PAGE_SIZE   = 9;    // 一度に表示
    const MAX_TITLE   = 70;   // タイトル長
    const MAX_EXCERPT = 220;  // 抜粋長

    let allItems = [];
    let filtered = [];
    let shown = 0;

    // --- fetchers ---
    async function fetchFromApi(apiName){
      if (!cfg.webAppUrl) return null;
      try {
        const r = await fetch(`${cfg.webAppUrl}?api=${apiName}&limit=${FETCH_LIMIT}`, { cache:'no-cache'  });
        if (!r.ok) return null;
        const data = await r.json();
        if (data && data.ok && Array.isArray(data.items)) return data.items;
      } catch(_){}
      return null;
    }
    async function fetchFromLocal(path){
      try {
        const r = await fetch(path, { cache:'no-cache'  });
        if (!r.ok) return null;
        const data = await r.json();
        if (data && (Array.isArray(data.items) || Array.isArray(data))) {
          return data.items || data;
        }
      } catch(_){}
      return null;
    }

    // blog抽出（newsからのフォールバックを想定）
    function looksLikeBlog(item){
      const cat = (item.category || '').toString().toLowerCase();
      const tags = (Array.isArray(item.tags) ? item.tags.join(',') : (item.tags || '')).toString().toLowerCase();
      const link = (item.link || '').toString().toLowerCase();
      const title = (item.title || '').toString().toLowerCase();
      // いずれか満たせば blog 扱い
      return (
        /blog|日誌|diary/.test(cat) ||
        /blog|日誌|diary/.test(tags) ||
        /\/blog|blog\.html\?/.test(link) ||
        /日誌|栽培|剪定|摘粒|誘引|植え付け|管理/.test(title)
      );
    }

    // --- helpers ---
    function escapeHtml_(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function truncate_(s, n){ const str = String(s||''); return (str.length > n) ? (str.slice(0, n-1) + '…') : str; }
    function formatJaDate_(iso){
      if (!iso) return '';
      const d = new Date(iso);
      if (isNaN(d)) {
        const m = String(iso).slice(0,10).split(/[-/.]/);
        if (m.length === 3) return `${m[0]}年${m[1]}月${m[2]}日`;
        return escapeHtml_(iso);
      }
      const y = d.getFullYear(), mm = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
      return `${y}年${mm}月${dd}日`;
    }

    // 追加：日時を確実に数値化（YYYY-MM-DD / YYYY-MM-DDTHH:mm:ss 両対応）
    function toTs_(v){
      if (!v) return -Infinity;
      if (v instanceof Date) return v.getTime();
      const s = String(v).trim();
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[T\s](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
      if (m){
        const y = +m[1], mo = +m[2]-1, d = +m[3];
        const hh = +(m[4]||0), mm = +(m[5]||0), ss = +(m[6]||0);
        return new Date(y, mo, d, hh, mm, ss).getTime();
      }
      const d = new Date(s);
      return isNaN(d) ? -Infinity : d.getTime();
    }

    /* ★ 追加：相対URL/slug/id/画像URL から“続きを読む”リンクを解決 */
    function resolveLink_(item, base){
      const cand = [
        item.link, item.url, item.page_url, item.href, item.permalink, item.path
      ].map(v => String(v || '').trim()).filter(Boolean);
      let raw = cand[0] || '';
      const slug = String(item.slug || item.id || '').trim();

      // 明示URL or 相対パス
      if (raw){
        if (/^https?:\/\//i.test(raw)) return { url: raw, external: true };
        if (/^\//.test(raw) || /^[A-Za-z0-9_\-\/]+(\.html?|\/)?$/i.test(raw)){
          return { url: raw.startsWith('/') ? raw : `/${raw}`, external: false };
        }
        // 「詳しくはこちら」などURLでない場合は無視して次の候補へ
      }

      // slug / id があれば /{base}/{slug}.html
      if (slug){
        const b = String(base || '').replace(/^\/|\/$/g,'');
        return { url: `/${b}/${encodeURIComponent(slug)}.html`, external: false };
      }

      // 最後の保険：画像URLが http(s) ならそこへ
      const img = String(item.image_url || '').trim();
      if (/^https?:\/\//i.test(img)) return { url: img, external: true };

      return null;
    }

    function renderChunk(){
      const next = filtered.slice(shown, shown + PAGE_SIZE);
      const html = next.map(item => {
        const img = item.image_url || 'assets/img/blog1.svg';
        const dateLabel = formatJaDate_(item.date || '');
        const title = truncate_(item.title || 'ぶどう日誌', MAX_TITLE);
        const excerpt = truncate_(item.excerpt || item.summary || '', MAX_EXCERPT);

        /* ★ 修正：ボタン生成を resolveLink_ に一本化 */
        const L = resolveLink_(item, 'blog');
        const btnHtml = L
          ? `<p style="margin-top:8px"><a class="btn" href="${L.url}" ${L.external ? 'target="_blank" rel="noopener"' : ''}>続きを読む</a></p>`
          : '';

        return `
          <article class="card post lift">
            <img src="${img}" alt="${escapeHtml_(item.title || '記事')}">
            <div>
              <h4>${escapeHtml_(title)}</h4>
              <time datetime="${item.date || ''}">${dateLabel}</time>
              <p>${escapeHtml_(excerpt)}</p>
              ${btnHtml}
            </div>
          </article>
        `;
      }).join('');

      listEl.insertAdjacentHTML('beforeend', html);
      shown += next.length;
      btn.style.display = shown >= filtered.length ? 'none' : '';
    }

    function applySearch(){
      const term = (q.value || '').trim().toLowerCase();
      if (!term){
        filtered = allItems.slice();
      } else {
        filtered = allItems.filter(it => {
          const hay = [it.title, it.excerpt, it.summary, it.tags, it.category].join(' ').toLowerCase();
          return hay.includes(term);
        });
      }
      // 再描画
      listEl.innerHTML = '';
      shown = 0;
      renderChunk();
    }

    // ---- init ----
    try {
      // 1) api=blog を試す
      let items = await fetchFromApi('blog');

      // 2) ダメなら api=news → blogっぽいものだけ抽出
      if (!items) {
        const news = await fetchFromApi('news');
        if (news) items = news.filter(looksLikeBlog);
      }

      // 3) まだ無ければローカル
      if (!items) {
        items = await fetchFromLocal('assets/data/blog.json'); // {items:[...]} でも [...] でもOK
      }

      // 無ければメッセージ
      if (!items || !items.length){
        listEl.innerHTML = `<div class="card"><p>現在、公開中の『ぶどう日誌』はありません。</p></div>`;
        btn.style.display = 'none';
        return;
      }

     　// 最新順（新しい→古い）※関数不要・不正日付は末尾へ
      items.sort((a,b) => (Date.parse(b.date || '') || -1) - (Date.parse(a.date || '') || -1));

      allItems = items;
      filtered = items.slice();

      renderChunk();

      btn.addEventListener('click', renderChunk);
      q.addEventListener('input', () => { applySearch(); });
    } catch(e){
      console.warn('[blog] fetch error:', e);
      listEl.innerHTML = `<div class="card"><p>読み込みに失敗しました。時間をおいて再度お試しください。</p></div>`;
      btn.style.display = 'none';
    }
  })();
  </script>
</body>
</html>
