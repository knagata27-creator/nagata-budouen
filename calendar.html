<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>収穫カレンダー｜ながたぶどう園</title>
  <meta name="description" content="ながたぶどう園の収穫カレンダー。品種ごとの収穫・出荷目安を月別にご案内（天候により前後）。" />
  <meta name="theme-color" content="#5b7a59" />

  <!-- OGP（任意） -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="収穫カレンダー｜ながたぶどう園" />
  <meta property="og:description" content="品種ごとの収穫・出荷目安。" />
  <meta property="og:image" content="assets/img/ogp.png" />
  <meta property="og:url" content="https://example.jp/calendar.html" />

  <link rel="icon" href="assets/img/ogp.png" />
  <link rel="stylesheet" href="assets/css/style.css" />

  <!-- index と同じ /exec を入れてください（必要なら） -->
  <script type="application/json" id="cfg-json">
    { "webAppUrl": "https://script.google.com/macros/s/AKfycbxvydZ5f3dqJ6aAaXZfBthd7g7s2OPLXoXkPIf0iIXPfJ5NQozl8CnTWlWNewpbJIhs/exec" }
  </script>

  <!-- ==== Page-local styles (table系は削除、カード系のみ残置) ==== -->
  <style>
    :root{
      --calapp-brand:#5b7a59;
      --calapp-ink:#243226;
      --calapp-sub:#5b6a5b;
      --calapp-line:#e9ece8;
      --calapp-bgh:#f6f8f5;
      --calapp-now:#e7efe7;
      --calapp-chip:#eef5ef;
      --calapp-range:rgba(91,122,89,.32);
      --calapp-range-brd:rgba(91,122,89,.55);
    }

    /* ---- hero ---- */
    .calapp-hero{background:#cfe2d2;border-bottom:1px solid var(--calapp-line);padding:14px 0 10px}
    .calapp-inner{max-width:980px;margin:0 auto;padding:0 16px}
    .calapp-kicker{display:inline-block;background:#e9f1ea;color:#31513a;border-radius:999px;font-weight:600;font-size:.86rem;padding:2px 10px;margin-bottom:6px}
    .calapp-hero h1{margin:0;color:#1f2a1f;font-size:clamp(22px,2.6vw,28px);line-height:1.25}
    .calapp-lead{margin:6px 0 0;color:#2f3b2f;font-size:clamp(14px,1.7vw,16px)}

    /* ---- toolbar ---- */
    .calapp-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .calapp-toolbar select,
    .calapp-toolbar input[type="search"]{border:1px solid #ddd;border-radius:12px;padding:.6em .9em;background:#fff}
    .calapp-toolbar label{display:flex;gap:.5em;align-items:center;color:#445;font-size:.95rem}
    .calapp-btn{display:inline-block;padding:.6em 1em;border-radius:12px;background:var(--calapp-brand);color:#fff;text-decoration:none;font-weight:600}

    /* ---- legend ---- */
    .calapp-legend{display:flex;gap:12px;flex-wrap:wrap;align-items:center;color:#566;font-size:.95rem;margin-top:6px}
    .calapp-legend i{display:inline-block;width:14px;height:14px;border:1px solid var(--calapp-range-brd);border-radius:6px;background:var(--calapp-range)}

    /* ---- card view ---- */
    .calapp-cards{display:grid;grid-template-columns:1fr;gap:12px}
    .calapp-card{border:1px solid var(--calapp-line);border-radius:14px;background:#fff;padding:12px}
    .calapp-card h3{margin:0 0 6px;font-size:1.05rem;color:var(--calapp-ink)}
    .calapp-chip{display:inline-block;background:var(--calapp-chip);border:1px solid #dfe8df;color:#355;padding:.15em .55em;border-radius:999px;font-size:.78em;margin-left:.4em}
    .calapp-chip--hot{background:#fff3e6;border-color:#ffe1bf;color:#9a5a00}
    .calapp-meta{ margin:6px 0 8px; font-size:.9rem; color:#556; }

    .calapp-range-bar{height:10px;border-radius:8px;background:linear-gradient(90deg,transparent, var(--calapp-range) 20%, var(--calapp-range) 80%, transparent)}
    .calapp-months{display:grid;grid-template-columns:repeat(12,1fr);gap:2px;margin-top:8px}
    .calapp-month{height:22px;border-radius:6px;background:#f5f7f4;display:flex;align-items:center;justify-content:center;font-size:.78rem;color:#667}
    .calapp-month.is-on{background:var(--calapp-range)}
    .calapp-month.is-now{outline:2px solid var(--calapp-range-brd)}

    .calapp-empty{padding:18px;text-align:center;color:#566}
  </style>
</head>
<body>
  <a class="skip-link" href="#main">本文へスキップ</a>

  <!-- ===== 既存サイトのヘッダー ===== -->
  <header class="site-header" role="banner">
    <div class="bar">
      <div class="inner">
        <h1 class="brand" aria-label="ながたぶどう園">
          <svg class="brand__logo" viewBox="0 0 24 24" aria-hidden="true"><circle cx="9" cy="8" r="3" fill="#fff" opacity="0.9"/><circle cx="14.5" cy="6.5" r="2.3" fill="#fff" opacity="0.85"/><circle cx="13" cy="10.5" r="2.6" fill="#fff" opacity="0.92"/><path d="M15 3c2 .3 2.8 1.4 3.3 2.4" stroke="#fff" stroke-width="1.2" fill="none" stroke-linecap="round"/></svg>
          <span class="brand__name">ながたぶどう園</span>
        </h1>

        <button class="nav-toggle" id="navToggle" aria-label="メニュー" aria-controls="primaryNav" aria-expanded="false">
          <span class="nav-toggle__bar" aria-hidden="true"></span>
        </button>

        <nav class="primary" id="primaryNav" role="navigation" aria-label="主なメニュー">
          <a href="index.html">ホーム</a>
          <a href="shop.html">注文する</a>
          <a href="gift.html">ギフト</a>
          <a href="calendar.html">収穫カレンダー</a>
          <a href="guide.html">はじめての方</a>
          <a href="news.html">最新情報</a>
          <a href="about.html">農園紹介</a>
          <a href="blog.html">ぶどう日誌</a>
          <a href="contact.html">お問い合わせ</a>
        </nav>
        </nav>
      </div>
    </div>
  </header>

  <main id="main">
    <!-- ===== ページ見出し ===== -->
    <section class="calapp-hero" aria-label="収穫カレンダー ヒーロー">
      <div class="calapp-inner">
        <span class="calapp-kicker">Harvest Calendar</span>
        <h1>収穫カレンダー</h1>
        <p class="calapp-lead">品種ごとの収穫・出荷の目安です（天候により前後します）。</p>

        <div class="calapp-toolbar" role="group" aria-label="絞り込み">
          <select id="calapp-month" aria-label="月で絞り込み">
            <option value="">すべての月</option>
            <option value="now">今月</option>
            <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
            <option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
            <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option>
            <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
          </select>
          <input id="calapp-search" type="search" placeholder="品種名で検索（例：シャイン・ナガノ）" aria-label="品種名で検索">
          <label><input id="calapp-nowOnly" type="checkbox"> 今季受付中のみ</label>
          <a class="calapp-btn" href="shop.html">最短の出荷目安を確認</a>
        </div>

        <div class="calapp-legend">
          <span><i></i> 収穫期（出荷目安）</span>
          <span>枠のある月＝今月</span>
          <span>※ 実際の受付は「最新情報」をご確認ください</span>
        </div>
      </div>
    </section>

    <!-- ===== カードビューのみ ===== -->
    <section class="calapp-inner" id="panel-card" role="region" aria-label="品種カード一覧">
      <!-- （任意）カードの見方：スマホ向けの補助凡例 -->
      <div class="calapp-legend" aria-label="カードの見方">
        <span><i></i> 塗りつぶし＝収穫期</span>
        <span>枠のある月＝今月</span>
        <span>数字＝1〜12月</span>
      </div>

      <div id="calapp-cards" class="calapp-cards" aria-live="polite" aria-busy="true">
        <!-- JSで描画 -->
      </div>
    </section>
  </main>

  <!-- ===== フッター ===== -->
  <footer role="contentinfo">
    <div class="container footer-inner">
      <div>
        <h3 class="footer-title">ながたぶどう園</h3>
        <p>長野県須坂市 日滝原</p>
        <p>お問い合わせ：<a href="mailto:info@example.jp">info@example.jp</a></p>
        <p>Instagram / YouTube / LINE 公式</p>
      </div>
      <div>
        <p>営業時間：9:00-17:00（季節により変動）</p>
        <p>※ 畑作業でお電話に出られない場合があります。メールでのご連絡が確実です。</p>
        <p><a href="law.html">特定商取引法に基づく表記</a> ／ <a href="privacy.html">プライバシーポリシー</a></p>
      </div>
      <div class="copyright">© 2025 ながたぶどう園</div>
    </div>
  </footer>

  <script src="assets/js/main.js"></script>

  <!-- ===== Calendar JS（表ビューロジック削除版） ===== -->
  <script>
  (async () => {
    const $ = (s, r = document) => r.querySelector(s);

    // elements（カードのみ）
    const cardsWrap = $('#calapp-cards');
    const selMonth  = $('#calapp-month');
    const boxSearch = $('#calapp-search');
    const onlyNow   = $('#calapp-nowOnly');

    // date
    const today = new Date();
    const THIS_M = today.getMonth() + 1; // 1..12

    // data
    let items = [];
    let viewData = [];

    // fetch calendar
    async function fetchCalendar(){
      const cfg = (() => {try{ return JSON.parse($('#cfg-json')?.textContent || '{}'); }catch(_){ return {}; }})();
      if (cfg.webAppUrl) {
        try{
          const r = await fetch(`${cfg.webAppUrl}?api=calendar`, {cache:'no-store'});
          if (r.ok) {
            const d = await r.json();
            if (d && d.ok && Array.isArray(d.items)) return d.items;
          }
        }catch(_){}
      }
      // fallback
      try{
        const r2 = await fetch('assets/data/calendar.json', {cache:'no-store'});
        if (r2.ok) {
          const d2 = await r2.json();
          if (Array.isArray(d2.items)) return d2.items;
          if (Array.isArray(d2)) return d2;
        }
      }catch(_){}
      // minimum
      return [
        { variety:'シャインマスカット', start:'2025-08-25', end:'2025-10-10', note:'冷蔵便・のし可' },
        { variety:'ナガノパープル',     start:'2025-09-01', end:'2025-10-05', note:'皮ごと食べられます' },
        { variety:'詰合せギフト',       start:'2025-08-25', end:'2025-10-10', note:'化粧箱・名入れ無料' }
      ];
    }

    // safe parsers
    function parseDate(v){
      if (!v) return null;
      if (Object.prototype.toString.call(v) === '[object Date]' && !isNaN(v)) {
        return new Date(v.getFullYear(), v.getMonth(), v.getDate());
      }
      const s = String(v).trim();
      if (/^\d+(\.\d+)?$/.test(s)) { // serial
        const n = Number(s);
        const ms = Math.round((n - 25569) * 86400 * 1000);
        const d = new Date(ms);
        return new Date(d.getFullYear(), d.getMonth(), d.getDate());
      }
      const m = s.match(/^\s*(\d{4})[^\d]?(\d{1,2})[^\d]?(\d{1,2})/);
      if (m) return new Date(+m[1], +m[2]-1, +m[3]);
      return null;
    }
    function monthOverlap(item, m1to12){
      const s = parseDate(item.start);
      const e = parseDate(item.end);
      if (!s || !e) return false;
      let sY = s.getFullYear(), eY = e.getFullYear();
      if (e < s) eY = sY + 1;
      const first = new Date(sY, m1to12 - 1, 1);
      const last  = new Date(sY, m1to12, 0);
      const sTime = s.getTime();
      const eTime = new Date(eY, e.getMonth(), e.getDate()).getTime();
      return (eTime >= first.getTime() && sTime <= last.getTime());
    }
    const isNow = (it)=> {
      const s = parseDate(it.start), e = parseDate(it.end);
      if (!s || !e) return false;
      const t = today.getTime();
      return s.getTime() <= t && t <= e.getTime();
    };
    const md = (d)=> d ? `${d.getMonth()+1}/${d.getDate()}` : '';
    const escapeHtml = (s)=> String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    // filter & render（カードのみ）
    function applyFilter(){
      const monthVal = selMonth.value;
      const term = (boxSearch.value || '').trim().toLowerCase();
      const needNow = !!onlyNow.checked;

      viewData = items.filter(it=>{
        if (term && !String(it.variety || it.name || '').toLowerCase().includes(term)) return false;
        if (needNow && !isNow(it)) return false;
        if (monthVal === 'now'){
          if (!monthOverlap(it, THIS_M)) return false;
        } else if (monthVal){
          if (!monthOverlap(it, parseInt(monthVal,10))) return false;
        }
        return true;
      });

      // start月 -> 品種名
      viewData.sort((a,b)=>{
        const am = parseDate(a.start)?.getMonth() ?? 99;
        const bm = parseDate(b.start)?.getMonth() ?? 99;
        if (am !== bm) return am - bm;
        return String(a.variety || a.name).localeCompare(String(b.variety || b.name),'ja');
      });

      renderCards();
    }

    function renderCards(){
      if (!viewData.length){
        cardsWrap.innerHTML = `<div class="calapp-empty">該当する品種がありません。</div>`;
        cardsWrap.setAttribute('aria-busy','false');
        return;
      }
      cardsWrap.innerHTML = viewData.map(it=>{
        const s = parseDate(it.start), e = parseDate(it.end);
        const name = escapeHtml(it.variety || it.name || '品種');
        const hot  = isNow(it) ? `<span class="calapp-chip calapp-chip--hot">受付中</span>` : '';
        const note = it.note || it.notes ? `<span class="calapp-chip">${escapeHtml(it.note || it.notes)}</span>` : '';
        const rangeText = (s && e)
          ? `収穫目安：${md(s)}〜${md(e)}（${s.getMonth()+1}〜${e.getMonth()+1}月）`
          : `収穫目安：未設定`;

        const months = Array.from({length:12},(_,i)=>{
          const m=i+1, on=monthOverlap(it,m);
          const cls = `calapp-month${on?' is-on':''}${(m===THIS_M)?' is-now':''}`;
          return `<div class="${cls}" aria-label="${m}月">${m}</div>`;
        }).join('');

        return `
          <article class="calapp-card">
            <h3>${name} ${hot} ${note}</h3>
            <p class="calapp-meta">${rangeText}</p>
            <div class="calapp-range-bar" title="${s&&e? md(s)+' – '+md(e) : ''}"></div>
            <div class="calapp-months">${months}</div>
          </article>`;
      }).join('');
      cardsWrap.setAttribute('aria-busy','false');
    }

    // init
    try{
      items = await fetchCalendar();
      items = items.map(it=>({
        variety: it.variety || it.name || '',
        start  : it.start || it.start_date || it.harvest_start || '',
        end    : it.end   || it.end_date   || it.harvest_end   || '',
        note   : it.note  || it.notes || '',
        link   : it.link || '',
        image  : it.image_url || it.image || ''
      }));
      viewData = items.slice();

      applyFilter();

      selMonth.addEventListener('change', applyFilter);
      boxSearch.addEventListener('input', applyFilter);
      onlyNow.addEventListener('change', applyFilter);
    }catch(e){
      console.warn('[calendar] error', e);
      cardsWrap.innerHTML = `<div class="calapp-empty">読み込みに失敗しました。時間をおいて再度お試しください。</div>`;
    }
  })();
  </script>
</body>
</html>
