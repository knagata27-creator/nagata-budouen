<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>収穫カレンダー｜ながたぶどう園</title>
  <meta name="description" content="ながたぶどう園の収穫カレンダー。品種ごとの収穫・出荷目安を月別にご案内（天候により前後）。" />
  <meta name="theme-color" content="#5b7a59" />

  <!-- OGP（任意） -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="収穫カレンダー｜ながたぶどう園" />
  <meta property="og:description" content="品種ごとの収穫・出荷目安。" />
  <meta property="og:image" content="assets/img/ogp.png" />
  <meta property="og:url" content="https://example.jp/calendar.html" />

  <link rel="icon" href="assets/img/ogp.png" />
  <link rel="stylesheet" href="assets/css/style.css" />

  <!-- index と同じ /exec を入れてください -->
  <script type="application/json" id="cfg-json">
    { "webAppUrl": "https://script.google.com/macros/s/AKfycbxFU43FHo-7Hj_3HhrONhdH19ChT9oloaQUoHEACqGsedIR5-m-uCR2f4MtNnLXhFWd/exec" }
  </script>

  <!-- ==== Page-local styles (scoped) ==== -->
  <style>
    :root{
      --calapp-brand:#5b7a59;
      --calapp-ink:#243226;
      --calapp-sub:#5b6a5b;
      --calapp-line:#e9ece8;
      --calapp-bgh:#f6f8f5;
      --calapp-now:#e7efe7;
      --calapp-chip:#eef5ef;
      --calapp-dot:#dfe7df;
      --calapp-range:rgba(91,122,89,.32);
      --calapp-range-brd:rgba(91,122,89,.55);
      --calapp-sticky-top:64px; /* サイトの固定ヘッダー高に合わせて調整 */
    }

    /* ---- hero ---- */
    .calapp-hero{background:#cfe2d2;border-bottom:1px solid var(--calapp-line);padding:14px 0 10px}
    .calapp-inner{max-width:980px;margin:0 auto;padding:0 16px}
    .calapp-kicker{display:inline-block;background:#e9f1ea;color:#31513a;border-radius:999px;font-weight:600;font-size:.86rem;padding:2px 10px;margin-bottom:6px}
    .calapp-hero h1{margin:0;color:#1f2a1f;font-size:clamp(22px,2.6vw,28px);line-height:1.25}
    .calapp-lead{margin:6px 0 0;color:#2f3b2f;font-size:clamp(14px,1.7vw,16px)}

    /* ---- toolbar ---- */
    .calapp-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .calapp-toolbar select,
    .calapp-toolbar input[type="search"]{border:1px solid #ddd;border-radius:12px;padding:.6em .9em;background:#fff}
    .calapp-toolbar label{display:flex;gap:.5em;align-items:center;color:#445; font-size:.95rem}
    .calapp-btn{display:inline-block;padding:.6em 1em;border-radius:12px;background:var(--calapp-brand);color:#fff;text-decoration:none;font-weight:600}

    /* ---- legend ---- */
    .calapp-legend{display:flex;gap:12px;flex-wrap:wrap;align-items:center;color:#566; font-size:.95rem;margin-top:6px}
    .calapp-legend i{display:inline-block;width:14px;height:14px;border:1px solid var(--calapp-range-brd);border-radius:6px;background:var(--calapp-range)}

    /* ---- tabs (view switch) ---- */
    .calapp-tabs{display:flex;gap:6px;margin:14px 0 0}
    .calapp-tab{border:1px solid var(--calapp-line);background:#fff;border-radius:12px;padding:.4em .8em;font-weight:600;color:#3a4;cursor:pointer}
    .calapp-tab[aria-selected="true"]{background:#eef5ef;border-color:#cfe0d0;color:#1f2}

    /* ---- table view ---- */
    .calapp-wrap{border:1px solid var(--calapp-line);border-radius:16px;background:#fff;overflow:hidden}
    .calapp-scroll{overflow:auto}
    .calapp-table{min-width:880px;width:100%;border-collapse:separate;border-spacing:0}
    .calapp-table thead th{position:sticky;top:var(--calapp-sticky-top);z-index:3;background:var(--calapp-bgh);border-bottom:1px solid var(--calapp-line);font-weight:700;color:#445;padding:.6em .7em}
    .calapp-table thead th+th{border-left:1px solid var(--calapp-line)}
    .calapp-rowhead{position:sticky;left:0;z-index:2;background:#fff;border-right:1px solid var(--calapp-line);padding:.7em .7em;white-space:nowrap}
    .calapp-chip{display:inline-block;background:var(--calapp-chip);border:1px solid #dfe8df;color:#355;padding:.15em .55em;border-radius:999px;font-size:.78em;margin-left:.4em}
    .calapp-chip--hot{background:#fff3e6;border-color:#ffe1bf;color:#9a5a00}
    .calapp-table tbody td{height:42px;padding:0;position:relative;border-left:1px solid var(--calapp-line)}
    .calapp-table tbody tr:nth-child(odd){background:#fcfdfb}
    .calapp-dot:before{content:"";position:absolute;inset:50% auto auto 50%;transform:translate(-50%,-50%);width:6px;height:6px;border-radius:999px;background:var(--calapp-dot);opacity:.7}
    .calapp-range{position:absolute;inset:8px 6px;border-radius:10px;background:var(--calapp-range);border:1px solid var(--calapp-range-brd)}
    /* 今月列の帯 */
    .calapp-table td[data-month="now"],
    .calapp-table th[data-month="now"]{background:var(--calapp-now)}
    .calapp-empty{padding:18px;text-align:center;color:#566}

    /* ---- card view (mobile-first) ---- */
    .calapp-cards{display:grid;grid-template-columns:1fr;gap:12px}
    .calapp-card{border:1px solid var(--calapp-line);border-radius:14px;background:#fff;padding:12px}
    .calapp-card h3{margin:0 0 6px;font-size:1.05rem;color:var(--calapp-ink)}
    .calapp-range-bar{height:10px;border-radius:8px;background:linear-gradient(90deg,transparent, var(--calapp-range) 20%, var(--calapp-range) 80%, transparent)}
    .calapp-months{display:grid;grid-template-columns:repeat(12,1fr);gap:2px;margin-top:8px}
    .calapp-month{height:22px;border-radius:6px;background:#f5f7f4;display:flex;align-items:center;justify-content:center;font-size:.78rem;color:#667}
    .calapp-month.is-on{background:var(--calapp-range)}
    .calapp-month.is-now{outline:2px solid var(--calapp-range-brd)}

    /* ---- responsive ---- */
    @media (max-width: 800px){
      .calapp-tabs{margin-top:10px}
      .calapp-wrap{border:none;background:transparent}
      .calapp-scroll{border:1px solid var(--calapp-line);border-radius:14px;background:#fff}
    }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">本文へスキップ</a>

  <!-- ===== 既存サイトのヘッダー（固定） ===== -->
  <header class="site-header" role="banner">
    <div class="bar">
      <div class="inner">
        <h1 class="brand" aria-label="ながたぶどう園">
          <svg class="brand__logo" viewBox="0 0 24 24" aria-hidden="true"><circle cx="9" cy="8" r="3" fill="#fff" opacity="0.9"/><circle cx="14.5" cy="6.5" r="2.3" fill="#fff" opacity="0.85"/><circle cx="13" cy="10.5" r="2.6" fill="#fff" opacity="0.92"/><path d="M15 3c2 .3 2.8 1.4 3.3 2.4" stroke="#fff" stroke-width="1.2" fill="none" stroke-linecap="round"/></svg>
          <span class="brand__name">ながたぶどう園</span>
        </h1>

        <button class="nav-toggle" id="navToggle" aria-label="メニュー" aria-controls="primaryNav" aria-expanded="false">
          <span class="nav-toggle__bar" aria-hidden="true"></span>
        </button>

        <nav class="primary" id="primaryNav" role="navigation" aria-label="主なメニュー">
          <a href="index.html">ホーム</a>
          <a class="nav-cta" href="shop.html">注文する</a>
          <a href="gift.html">ギフト</a>
          <a class="is-active" href="calendar.html" aria-current="page">収穫カレンダー</a>
          <a href="guide.html">はじめての方</a>
          <a href="news.html">最新情報</a>
          <a href="blog.html">ぶどう日誌</a>
          <a href="about.html">農園紹介</a>
          <a href="contact.html">お問い合わせ</a>
        </nav>
      </div>
    </div>
  </header>

  <main id="main">
    <!-- ===== ページ見出し ===== -->
    <section class="calapp-hero" aria-label="収穫カレンダー ヒーロー">
      <div class="calapp-inner">
        <span class="calapp-kicker">Harvest Calendar</span>
        <h1>収穫カレンダー</h1>
        <p class="calapp-lead">品種ごとの収穫・出荷の目安です（天候により前後します）。</p>

        <div class="calapp-toolbar" role="group" aria-label="絞り込み">
          <select id="calapp-month" aria-label="月で絞り込み">
            <option value="">すべての月</option>
            <option value="now">今月</option>
            <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
            <option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
            <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option>
            <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
          </select>
          <input id="calapp-search" type="search" placeholder="品種名で検索（例：シャイン・ナガノ）" aria-label="品種名で検索">
          <label><input id="calapp-nowOnly" type="checkbox"> 今季受付中のみ</label>
          <a class="calapp-btn" href="shop.html">最短の出荷目安を確認</a>
        </div>

        <div class="calapp-legend">
          <span><i></i> 収穫期（出荷目安）</span>
          <span>今月列は淡い帯でハイライト</span>
          <span>※ 実際の受付は「最新情報」をご確認ください</span>
        </div>

        <div class="calapp-tabs" role="tablist" aria-label="表示切替">
          <button class="calapp-tab" role="tab" id="tab-table" aria-controls="panel-table" aria-selected="true">表（年表）</button>
          <button class="calapp-tab" role="tab" id="tab-card" aria-controls="panel-card" aria-selected="false">カード</button>
        </div>
      </div>
    </section>

    <!-- ===== 表ビュー ===== -->
    <section class="calapp-inner" id="panel-table" role="tabpanel" aria-labelledby="tab-table">
      <div class="calapp-wrap">
        <div class="calapp-scroll" id="calapp-tableWrap" aria-live="polite" aria-busy="true">
          <!-- JSで描画 -->
        </div>
      </div>
    </section>

    <!-- ===== カードビュー ===== -->
    <section class="calapp-inner" id="panel-card" role="tabpanel" aria-labelledby="tab-card" hidden>
      <div id="calapp-cards" class="calapp-cards" aria-live="polite" aria-busy="true">
        <!-- JSで描画 -->
      </div>
    </section>
  </main>

  <!-- ===== フッター ===== -->
  <footer role="contentinfo">
    <div class="container footer-inner">
      <div>
        <h3 class="footer-title">ながたぶどう園</h3>
        <p>長野県須坂市 日滝原</p>
        <p>お問い合わせ：<a href="mailto:info@example.jp">info@example.jp</a></p>
        <p>Instagram / YouTube / LINE 公式</p>
      </div>
      <div>
        <p>営業時間：9:00-17:00（季節により変動）</p>
        <p>※ 畑作業でお電話に出られない場合があります。メールでのご連絡が確実です。</p>
        <p><a href="law.html">特定商取引法に基づく表記</a> ／ <a href="privacy.html">プライバシーポリシー</a></p>
      </div>
      <div class="copyright">© 2025 ながたぶどう園</div>
    </div>
  </footer>

  <script src="assets/js/main.js"></script>

  <!-- ===== Calendar JS (scoped) ===== -->
  <script>
  (async () => {
    // ---- elements ----
    const $ = (s, r = document) => r.querySelector(s);
    const tableWrap = $('#calapp-tableWrap');
    const cardsWrap = $('#calapp-cards');
    const selMonth  = $('#calapp-month');
    const boxSearch = $('#calapp-search');
    const onlyNow   = $('#calapp-nowOnly');
    const tabTable  = $('#tab-table');
    const tabCard   = $('#tab-card');
    const panelTable= $('#panel-table');
    const panelCard = $('#panel-card');

    // ---- date ----
    const today = new Date();
    const THIS_M = today.getMonth() + 1; // 1..12

    // ---- data ----
    let items = [];
    let viewData = [];

    // ---- fetch ----
    async function fetchCalendar(){
      const cfg = (() => {try{ return JSON.parse($('#cfg-json')?.textContent || '{}'); }catch(_){ return {}; }})();
      // 1) GAS
      if (cfg.webAppUrl) {
        try{
          const r = await fetch(`${cfg.webAppUrl}?api=calendar`, {cache:'no-store'});
          if (r.ok) {
            const d = await r.json();
            if (d && d.ok && Array.isArray(d.items)) return d.items;
          }
        }catch(_){}
      }
      // 2) local fallback
      try{
        const r2 = await fetch('assets/data/calendar.json', {cache:'no-store'});
        if (r2.ok) {
          const d2 = await r2.json();
          if (Array.isArray(d2.items)) return d2.items;
          if (Array.isArray(d2)) return d2;
        }
      }catch(_){}
      // 3) minimum
      return [
        { variety:'シャインマスカット', start:'2025-08-25', end:'2025-10-10', note:'冷蔵便・のし可' },
        { variety:'ナガノパープル',     start:'2025-09-01', end:'2025-10-05', note:'皮ごと食べられます' },
        { variety:'詰合せギフト',       start:'2025-08-25', end:'2025-10-10', note:'化粧箱・名入れ無料' }
      ];
    }

    // ---- utils ----
    const parseDate = (s)=> {
      if (!s) return null;
      const d = new Date(s);
      if (!isNaN(d)) return d;
      const m = String(s).slice(0,10).split(/[-/.]/);
      return (m.length===3) ? new Date(+m[0], +m[1]-1, +m[2]) : null;
    };
    const monthOverlap = (item, m1to12)=>{ // その月にかかる？
      const s = parseDate(item.start), e = parseDate(item.end);
      if (!s || !e) return false;
      const y = s.getFullYear();
      const first = new Date(y, m1to12 - 1, 1);
      const last  = new Date(y, m1to12, 0, 23, 59, 59);
      return (e >= first && s <= last);
    };
    const isNow = (item) => {
      const s = parseDate(item.start), e = parseDate(item.end);
      if (!s || !e) return false;
      const t = today.getTime();
      return s.getTime() <= t && t <= e.getTime();
    };
    const md = (d)=> d ? `${d.getMonth()+1}/${d.getDate()}` : '';

    // ---- filter & sort ----
    function applyFilter(){
      const monthVal = selMonth.value;
      const term = (boxSearch.value || '').trim().toLowerCase();
      const needNow = !!onlyNow.checked;

      viewData = items.filter(it=>{
        if (term && !String(it.variety || it.name || '').toLowerCase().includes(term)) return false;
        if (needNow && !isNow(it)) return false;
        if (monthVal === 'now'){
          if (!monthOverlap(it, THIS_M)) return false;
        } else if (monthVal){
          if (!monthOverlap(it, parseInt(monthVal,10))) return false;
        }
        return true;
      });

      // start月 -> 品種名
      viewData.sort((a,b)=>{
        const am = parseDate(a.start)?.getMonth() ?? 99;
        const bm = parseDate(b.start)?.getMonth() ?? 99;
        if (am !== bm) return am - bm;
        return String(a.variety || a.name).localeCompare(String(b.variety || b.name),'ja');
      });

      renderTable();
      renderCards();
    }

    // ---- render: table ----
    function renderTable(){
      if (!viewData.length){
        tableWrap.innerHTML = `<div class="calapp-empty">該当する品種がありません。</div>`;
        tableWrap.setAttribute('aria-busy','false');
        return;
      }
      const head = `
        <table class="calapp-table" role="table" aria-describedby="calendar-desc">
          <colgroup>
            <col style="width:220px">
            ${Array.from({length:12},()=>'<col>').join('')}
          </colgroup>
          <thead>
            <tr>
              <th scope="col" class="calapp-rowhead" data-month="">品種</th>
              ${Array.from({length:12},(_,i)=>{
                const m=i+1;
                const now = (m===THIS_M) ? ' data-month="now"' : '';
                return `<th scope="col"${now}>${m}月</th>`;
              }).join('')}
            </tr>
          </thead>
          <tbody>
            ${viewData.map(it=>{
              const s = parseDate(it.start), e = parseDate(it.end);
              const tip = (s&&e) ? `${md(s)} – ${md(e)}` : '';
              const name = it.variety || it.name || '品種';
              const hot  = isNow(it) ? `<span class="calapp-chip calapp-chip--hot">受付中</span>` : '';
              const note = it.note || it.notes ? `<span class="calapp-chip">${escapeHtml(it.note || it.notes)}</span>` : '';

              const cells = Array.from({length:12},(_,i)=>{
                const m=i+1;
                const on = monthOverlap(it,m);
                const now= (m===THIS_M) ? ' data-month="now"' : '';
                const dot = on ? '' : ' calapp-dot';
                const range = on ? `<div class="calapp-range" title="${tip}"></div>` : '';
                return `<td${now} class="${dot}" aria-label="${m}月">${range}</td>`;
              }).join('');

              return `
                <tr>
                  <th scope="row" class="calapp-rowhead">
                    <span>${escapeHtml(name)}</span>${hot}${note}
                  </th>
                  ${cells}
                </tr>`;
            }).join('')}
          </tbody>
        </table>`;
      tableWrap.innerHTML = head;
      tableWrap.setAttribute('aria-busy','false');
    }

    // ---- render: cards ----
    function renderCards(){
      if (!viewData.length){
        cardsWrap.innerHTML = `<div class="calapp-empty">該当する品種がありません。</div>`;
        cardsWrap.setAttribute('aria-busy','false');
        return;
      }
      cardsWrap.innerHTML = viewData.map(it=>{
        const s = parseDate(it.start), e = parseDate(it.end);
        const name = escapeHtml(it.variety || it.name || '品種');
        const hot  = isNow(it) ? `<span class="calapp-chip calapp-chip--hot">受付中</span>` : '';
        const note = it.note || it.notes ? `<span class="calapp-chip">${escapeHtml(it.note || it.notes)}</span>` : '';
        const months = Array.from({length:12},(_,i)=>{
          const m=i+1, on=monthOverlap(it,m);
          const cls = `calapp-month${on?' is-on':''}${(m===THIS_M)?' is-now':''}`;
          return `<div class="${cls}" aria-hidden="true">${m}</div>`;
        }).join('');

        return `
          <article class="calapp-card">
            <h3>${name} ${hot} ${note}</h3>
            <div class="calapp-range-bar" title="${s&&e? md(s)+' – '+md(e) : ''}"></div>
            <div class="calapp-months">${months}</div>
          </article>`;
      }).join('');
      cardsWrap.setAttribute('aria-busy','false');
    }

    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

    // ---- tab switch ----
    function setTab(which){
      const tableActive = (which === 'table');
      tabTable.setAttribute('aria-selected', tableActive ? 'true' : 'false');
      tabCard.setAttribute('aria-selected', tableActive ? 'false' : 'true');
      panelTable.hidden = !tableActive;
      panelCard.hidden  = tableActive;
    }
    tabTable.addEventListener('click', ()=> setTab('table'));
    tabCard.addEventListener('click',  ()=> setTab('card'));

    // ---- init ----
    try{
      items = await fetchCalendar();
      // 正規化
      items = items.map(it=>({
        variety: it.variety || it.name || '',
        start  : it.start || it.start_date || it.harvest_start || '',
        end    : it.end   || it.end_date   || it.harvest_end   || '',
        note   : it.note  || it.notes || '',
        link   : it.link || '',
        image  : it.image_url || it.image || ''
      }));
      viewData = items.slice();

      // モバイルは初期表示をカードに
      if (window.matchMedia('(max-width: 800px)').matches) setTab('card');

      applyFilter();

      selMonth.addEventListener('change', applyFilter);
      boxSearch.addEventListener('input', applyFilter);
      onlyNow.addEventListener('change', applyFilter);
    }catch(e){
      console.warn('[calendar] error', e);
      tableWrap.innerHTML = `<div class="calapp-empty">読み込みに失敗しました。時間をおいて再度お試しください。</div>`;
      cardsWrap.innerHTML = `<div class="calapp-empty">読み込みに失敗しました。時間をおいて再度お試しください。</div>`;
    }
  })();
  </script>
</body>
</html>
