<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç›´è²©ï¼ˆShopï¼‰ï½œãªãŒãŸã¶ã©ã†åœ’</title>

  <meta name="description" content="ãªãŒãŸã¶ã©ã†åœ’ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç›´è²©ã€‚ã‚·ãƒ£ã‚¤ãƒ³ãƒã‚¹ã‚«ãƒƒãƒˆãƒ»ãƒŠã‚¬ãƒãƒ‘ãƒ¼ãƒ—ãƒ«ãƒ»è©°åˆã›ãƒ»è¨³ã‚ã‚Šã€‚ä¾¡æ ¼ãƒ»è¦æ ¼ãƒ»ã®ã—å¯¾å¿œãƒ»å‡ºè·ç›®å®‰ã‚’æ˜è¨˜ã—ã€ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã”æ³¨æ–‡ã„ãŸã ã‘ã¾ã™ã€‚" />
  <meta name="theme-color" content="#5b7a59" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç›´è²©ï¼ˆShopï¼‰ï½œãªãŒãŸã¶ã©ã†åœ’" />
  <meta property="og:description" content="æ—¬ã®ã¶ã©ã†ã‚’ç”£åœ°ç›´é€ã€‚ã‚®ãƒ•ãƒˆãƒ»ã®ã—ç„¡æ–™ã€ã‚¯ãƒ¼ãƒ«ä¾¿ã§ãŠå±Šã‘ã€‚" />
  <meta property="og:url" content="https://example.jp/shop.html" />
  <meta property="og:image" content="assets/img/ogp.png" />

  <link rel="icon" href="assets/img/ogp.png" />
  <link rel="stylesheet" href="assets/css/style.css?v=20251013" />
  <!-- JSæ¤œå‡ºï¼ˆrevealå®‰å…¨åŒ–ï¼‰ -->
  <script>document.documentElement.classList.add('js');</script>

  <!-- â–¼ GASã‹ã‚‰åŸ‹ã‚è¾¼ã‚€è¨­å®šï¼ˆæœªå®šç¾©ã§ã‚‚å‹•ä½œï¼‰ -->
  <script type="application/json" id="cfg-json">
  <?!= JSON.stringify(deployConfig) ?>
  </script>

  <!-- â–¼ GASç‰ˆUIã®CSSã‚’ #shopApp ã«ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆâ€»æ—¢å­˜ã¨åŒã˜ï¼‰ -->
  <style>
    #shopApp { --gap:14px; --radius:16px; }

    /* ã‚«ãƒ¼ãƒ‰ */
    #shopApp .card{position:relative;border:1px solid #e8e8e8;border-radius:var(--radius);background:#fff;overflow:hidden;display:flex;flex-direction:column}
    #shopApp .card img{width:100%;object-fit:cover;background:#f2f2f2;aspect-ratio:4/3}
    @media (min-width:900px){ #shopApp .card img{height:360px} }
    @media (max-width:767px){ #shopApp .card img{aspect-ratio:16/10} #shopApp .card .body{font-size:15px} }
    #shopApp .card .body{padding:12px;display:grid;gap:8px}
    #shopApp .name{font-weight:700;font-size:22px}
    #shopApp .meta{color:#666;font-size:15px;line-height:1.6}

    /* è¡Œãƒ»æ•°é‡ãƒ»ãƒœã‚¿ãƒ³ */
    #shopApp .row{display:flex;align-items:center;gap:12px;margin-top:8px}
    #shopApp .qty select.qty-select{width:110px;height:44px;font-size:16px;border:1px solid #ddd;border-radius:10px;background:#fff;padding:0 8px}
    #shopApp #grid .qty-select{flex:0 0 auto}
    #shopApp #grid .btn.btn--wide{flex:1 1 auto;min-width:auto}
    @media (max-width:600px){ #shopApp .qty select.qty-select{width:120px;height:48px;font-size:17px} }
    #shopApp .btn{cursor:pointer;border:0;background:#111;color:#fff;padding:12px 18px;border-radius:12px;font-size:16px;min-height:44px;transition:background .2s ease}
    #shopApp .btn:hover:enabled{background:#333}
    #shopApp .btn:disabled{background:#aaa;cursor:not-allowed}
    #shopApp .btn--wide{align-self:flex-end;min-width:160px}

    /* å£²åˆ‡ã‚Œ */
    #shopApp .card.soldout{filter:grayscale(.2) brightness(.85);pointer-events:none}
    #shopApp .card.soldout::after{content:"å£²ã‚Šåˆ‡ã‚Œ";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:28px;letter-spacing:.08em;color:#fff;background:rgba(20,20,20,.55);text-shadow:0 2px 8px rgba(0,0,0,.45)}

    /* ä¸‹å›ºå®šã‚«ãƒ¼ãƒˆãƒãƒ¼ */
    #shopApp .cart-sticky{
      position:fixed;left:0;right:0;bottom:0;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px calc(14px + env(safe-area-inset-bottom,0));
      background:#111;color:#fff;box-shadow:0 -8px 24px rgba(0,0,0,.22);
      z-index:9999;transition:background .2s ease,transform .08s ease;transform:translateZ(0);
    }
    #shopApp .cart-sticky:hover{background:#333}
    #shopApp .cart-sticky:active{transform:translateY(1px)}
    #shopApp .cart-sticky__left{display:flex;align-items:center;gap:10px;font-size:16px}
    #shopApp .cart-sticky__icon{font-size:20px}
    #shopApp .cart-sticky__badge{display:inline-block;min-width:26px;text-align:center;padding:4px 8px;border-radius:999px;background:#e53935;color:#fff;font-weight:700}
    #shopApp .cart-sticky__cta{display:inline-flex;align-items:center;justify-content:center;padding:12px 18px;background:#fff;color:#111;border-radius:999px;font-size:16px;font-weight:800;min-width:160px;box-shadow:0 3px 10px rgba(0,0,0,.15);transition:transform .08s ease,background .2s ease}
    #shopApp .cart-sticky:hover .cart-sticky__cta{background:#f2f2f2}
    #shopApp .cart-sticky:active .cart-sticky__cta{transform:scale(.98)}

    /* ãƒˆãƒ¼ã‚¹ãƒˆ */
    #shopApp .toast{position:fixed;right:12px;bottom:12px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.3s;z-index:10000}
    #shopApp .toast.show{opacity:1;transform:translateY(0)}

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #shopApp .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:9998}
    #shopApp .modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid #ddd;border-radius:16px;width:min(960px,92vw);max-height:90vh;overflow:auto;padding:16px;z-index:9999;display:none;scroll-padding-bottom:calc(120px + env(safe-area-inset-bottom,0))}
    #shopApp .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    #shopApp .modal table{width:100%;border-collapse:collapse;margin-top:8px}
    #shopApp .modal th,#shopApp .modal td{border-bottom:1px solid #eee;padding:8px;font-size:14px;text-align:left;white-space:nowrap}
    #shopApp .modal tfoot td{font-weight:700}
    #shopApp .modal .form{display:grid;gap:10px;margin-top:14px}
    #shopApp .modal input,#shopApp .modal textarea,#shopApp .modal select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:16px;scroll-margin-bottom:120px}
    #shopApp .modal .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}

    /* ã‚«ãƒ«ãƒ¼ã‚»ãƒ« */
    #shopApp .carousel{position:relative;overflow:auto;scroll-snap-type:x mandatory;display:grid;grid-auto-flow:column;grid-auto-columns:100%;border-bottom:1px solid #eee}
    #shopApp .carousel img{width:100%;height:auto;aspect-ratio:16/9;object-fit:cover;scroll-snap-align:start;background:#f2f2f2}
    @media (min-width:900px){ #shopApp .carousel img{aspect-ratio:4/3;height:360px} }
    #shopApp .carousel-dots{position:absolute;left:0;right:0;bottom:8px;display:flex;justify-content:center;gap:6px}
    #shopApp .carousel-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.65);box-shadow:0 1px 4px rgba(0,0,0,.25)}
    #shopApp .carousel-dot.is-active{background:#fff}

    /* ã‚¿ã‚°ãƒãƒƒã‚¸ */
    #shopApp .badges{position:absolute;top:10px;left:10px;display:flex;gap:6px;flex-wrap:wrap}
    #shopApp .badge-chip{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;color:#fff;background:#111;box-shadow:0 2px 6px rgba(0,0,0,.25)}
    #shopApp .badge-chip.is-new{background:#13b981}
    #shopApp .badge-chip.is-hit{background:#ef4444}
    #shopApp .badge-chip.is-season{background:#3b82f6}

    /* å•†å“ã‚°ãƒªãƒƒãƒ‰ */
    #shopApp #grid.product-grid{display:grid;grid-template-columns:1fr;gap:var(--gap)}
    @media (min-width:700px){ #shopApp #grid.product-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
    @media (min-width:1100px){ #shopApp #grid.product-grid{grid-template-columns:repeat(3,minmax(0,1fr));gap:24px} }

    /* ã‚¹ã‚±ãƒ«ãƒˆãƒ³ */
    #shopApp .skeleton{background:linear-gradient(90deg,#eee 25%,#ddd 37%,#eee 63%);background-size:400% 100%;animation:skeleton-loading 1.4s ease infinite;border-radius:8px}
    @keyframes skeleton-loading{0%{background-position:100% 50%}100%{background-position:0 50%}}
    #shopApp .skel-card{border:1px solid #e8e8e8;border-radius:var(--radius);background:#fff;overflow:hidden;display:flex;flex-direction:column}
    #shopApp .skel-card .body{padding:12px;display:grid;gap:8px}

    /* æŠ¼ä¸‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
    #shopApp .pressable{position:relative;transition:transform .08s ease,filter .12s ease,box-shadow .12s ease,background-color .12s ease;will-change:transform}
    #shopApp .pressable:active,#shopApp .pressable.is-pressed{transform:translateY(1px) scale(.985);filter:brightness(.96)}
    #shopApp .btn.pressable{box-shadow:0 3px 10px rgba(0,0,0,.15)}
    #shopApp .btn.pressable.is-pressed{box-shadow:inset 0 2px 6px rgba(0,0,0,.12)}
    #shopApp .cart-sticky.pressable,#shopApp .cart-btn.pressable,#shopApp .cart-sticky__cta.pressable{transition:transform .08s ease,background .12s ease,box-shadow .12s ease}
    #shopApp .cart-sticky.pressable.is-pressed,#shopApp .cart-btn.pressable.is-pressed,#shopApp .cart-sticky__cta.pressable.is-pressed{transform:translateY(1px) scale(.99)}
    #shopApp .pressable:focus-visible{outline:3px solid #99c2ff;outline-offset:2px;border-radius:12px}
    @media (prefers-reduced-motion:reduce){ #shopApp .pressable{transition:none} }
  </style>

  <!-- â–¼ è¿½åŠ ï¼šå›ºå®šãƒãƒ¼ã«éš ã‚Œãªã„ä½™ç™½ï¼ˆè©²å½“ç®‡æ‰€ã®æœ€å°ä¿®æ­£ï¼‰ -->
  <style>
    body.has-sticky-cart{ padding-bottom:110px; }
  </style>
</head>

<!-- â–¼ è¿½åŠ ï¼šç”»é¢ä¸‹å›ºå®šãƒãƒ¼ã«åˆã‚ã›ã¦ä½™ç™½ã‚’ä»˜ä¸ -->
<body class="has-sticky-cart">
  <a class="skip-link" href="#main">æœ¬æ–‡ã¸ã‚¹ã‚­ãƒƒãƒ—</a>

  <!-- ===== Header / Global Nav ===== -->
  <header class="site-header" role="banner">
    <div class="bar">
      <div class="inner">
        <h1 class="brand" aria-label="ãªãŒãŸã¶ã©ã†åœ’">
          <svg class="brand__logo" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <circle cx="9" cy="8" r="3" fill="#fff" opacity="0.9"/>
            <circle cx="14.5" cy="6.5" r="2.3" fill="#fff" opacity="0.85"/>
            <circle cx="13" cy="10.5" r="2.6" fill="#fff" opacity="0.92"/>
            <path d="M15 3c2 .3 2.8 1.4 3.3 2.4" stroke="#fff" stroke-width="1.2" fill="none" stroke-linecap="round"/>
          </svg>
          <span class="brand__name">ãªãŒãŸã¶ã©ã†åœ’</span>
        </h1>

        <button class="nav-toggle" id="navToggle" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" aria-controls="primaryNav" aria-expanded="false">
          <span class="nav-toggle__bar" aria-hidden="true"></span>
        </button>

        <nav class="primary" id="primaryNav" role="navigation" aria-label="ä¸»ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼">
          <a href="index.html#shop" class="is-active">æ³¨æ–‡ã™ã‚‹</a>
          <a href="gift.html">ã‚®ãƒ•ãƒˆ</a>
          <a href="calendar.html">åç©«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</a>
          <a href="guide.html">ã¯ã˜ã‚ã¦ã®æ–¹</a>
          <a href="about.html">è¾²åœ’ç´¹ä»‹</a>
          <a href="blog.html">ã¶ã©ã†æ—¥èªŒ</a>
          <a href="contact.html">ãŠå•ã„åˆã‚ã›</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- ===== Fixed Status Bar ===== -->
  <div class="status" role="status" aria-live="polite">
    <div class="inner">
      <span class="pill" id="statusMode">å—ä»˜çŠ¶æ³</span>
      <span id="statusMsg">èª­ã¿è¾¼ã¿ä¸­â€¦</span>
      <span class="sep">|</span>
      <a id="statusLink" href="index.html#news">æœ€æ–°ã®ãŠçŸ¥ã‚‰ã›</a>
    </div>
  </div>

  <main id="main">
    <!-- ===== Heroï¼ˆè²©å£²çŠ¶æ³Ã—æœ€çŸ­å°ç·šï¼‰ ===== -->
    <section class="section">
      <div class="container two-col">
        <div class="card lift">
          <h1 class="section-title deco" style="margin-top:0">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç›´è²©ï¼ˆShopï¼‰</h1>
          <p class="section-lead" id="heroLead">
            <b id="heroMode">å—ä»˜ä¸­</b>ï½œæœ¬æ—¥17æ™‚ã¾ã§ã®ã”æ³¨æ–‡ã¯ <strong id="shipEta">2â€“4æ—¥ã§å‡ºè·</strong>ã€‚
          </p>
          <ul class="list muted">
            <li>ã‚¯ãƒ¼ãƒ«ä¾¿ï¼ã®ã—ãƒ»åå…¥ã‚Œç„¡æ–™ï¼ˆã‚®ãƒ•ãƒˆï¼‰</li>
            <li>é€æ–™ï¼š<b><span id="ship">â€“</span> å††</b>ï¼ˆåœ°åŸŸã«ã‚ˆã‚ŠåŠ ç®—ã‚ã‚Šï¼‰</li>
          </ul>
          <div class="btn-row">
            <a class="btn btn--fill" href="#catalog">å•†å“ä¸€è¦§ã¸</a>
            <a class="btn" href="gift.html">ã‚®ãƒ•ãƒˆã®ã”æ¡ˆå†…</a>
            <a class="btn" href="guide.html">é€æ–™ãƒ»ãŠæ”¯æ‰•ã„ãƒ»FAQ</a>
          </div>
        </div>
        <div class="ratio-3x2 radius-16 shadow-soft overflow-hidden">
          <img src="assets/img/hero.svg" alt="æ—¬ã®ã¶ã©ã†ã‚’ç”£åœ°ç›´é€">
        </div>
      </div>
    </section>

    <!-- ===== GASå•†å“UIï¼ˆã‚¹ã‚³ãƒ¼ãƒ—ï¼š#shopAppï¼‰ ===== -->
    <section class="section" id="catalog">
      <div class="container">
        <div id="shopApp">
          <header style="display:flex;justify-content:space-between;align-items:center;margin:0 0 10px">
            <div style="font-weight:700">å•†å“ä¸€è¦§</div>
            <button id="openCart" class="btn cart-btn" type="button" aria-label="ã‚«ãƒ¼ãƒˆã‚’é–‹ã">
              <span aria-hidden="true">ğŸ›’</span> ã‚«ãƒ¼ãƒˆ
              <span id="cartCountHead" class="cart-sticky__badge">0</span>
            </button>
          </header>

          <div id="grid" class="product-grid">
            <!-- JSãŒå•†å“ã‚’æç”»ã€‚èµ·å‹•ç›´å¾Œã¯ã‚¹ã‚±ãƒ«ãƒˆãƒ³è¡¨ç¤º -->
          </div>

          <!-- ç”»é¢ä¸‹ã®å›ºå®šã‚«ãƒ¼ãƒˆãƒãƒ¼ -->
          <button id="stickyCart" class="cart-sticky" type="button" aria-label="ã‚«ãƒ¼ãƒˆã‚’é–‹ã">
            <span class="cart-sticky__left">
              <span class="cart-sticky__icon" aria-hidden="true">ğŸ›’</span>
              <span class="cart-sticky__label">ã‚«ãƒ¼ãƒˆ</span>
              <span id="cartCountSticky" class="cart-sticky__badge">0</span>
            </span>
            <span class="cart-sticky__cta">ãƒ¬ã‚¸ã«é€²ã‚€ âœ</span>
          </button>

          <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚«ãƒ¼ãƒˆï¼‹ãŠå®¢æ§˜æƒ…å ±ï¼‰ -->
          <div id="checkoutOverlay" class="modal-overlay"></div>
          <div id="checkoutModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="checkoutTitle">
            <header>
              <h2 id="checkoutTitle" style="margin:0;font-size:18px;">ã”æ³¨æ–‡å†…å®¹</h2>
              <button class="btn" type="button" id="m-close">é–‰ã˜ã‚‹</button>
            </header>

            <section>
              <table id="modalCartTable">
                <thead>
                  <tr><th>å•†å“å</th><th>æ•°é‡</th><th style="width:120px">å°è¨ˆ</th><th style="width:72px"></th></tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr><td>å°è¨ˆ</td><td></td><td id="m-subtotal">0</td><td></td></tr>
                  <tr><td>é€æ–™</td><td></td><td id="m-shipping">0</td><td></td></tr>
                  <tr><td>åˆè¨ˆ</td><td></td><td id="m-total">0</td><td></td></tr>
                </tfoot>
              </table>
            </section>

            <section class="form">
              <h3 style="margin:6px 0 0;">ãŠå®¢æ§˜æƒ…å ±</h3>
              <input required type="text"  id="m-name"    placeholder="æ°å">
              <input required type="email" id="m-email"   placeholder="ãƒ¡ãƒ¼ãƒ«">
              <input type="text"          id="m-tel"     placeholder="é›»è©±">
              <input type="text"          id="m-addr"    placeholder="ä½æ‰€">
              <textarea id="m-note" rows="3" placeholder="å‚™è€ƒï¼ˆã®ã—ç­‰ã‚ã‚Œã°ï¼‰"></textarea>
              <select id="m-pay">
                <option value="éŠ€è¡ŒæŒ¯è¾¼">éŠ€è¡ŒæŒ¯è¾¼</option>
                <option value="ä»£é‡‘å¼•æ›">ä»£é‡‘å¼•æ›</option>
                <option value="åº—é ­æ”¯æ‰•">åº—é ­æ”¯æ‰•</option>
              </select>
              <div class="actions">
                <button class="btn" type="button" id="m-back">æˆ»ã‚‹</button>
                <button id="m-submit" class="btn" type="button">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
              </div>
            </section>
          </div>

          <div id="toast" class="toast" role="status" aria-live="polite"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Footer ===== -->
  <footer role="contentinfo">
    <div class="container footer-inner">
      <div>
        <h3 class="footer-title">ãªãŒãŸã¶ã©ã†åœ’</h3>
        <p>é•·é‡çœŒé ˆå‚å¸‚ æ—¥æ»åŸ</p>
        <p>ãŠå•ã„åˆã‚ã›ï¼š<a href="mailto:info@example.jp">info@example.jp</a></p>
        <p>Instagram / YouTube / LINE å…¬å¼</p>
      </div>
      <div>
        <p>å–¶æ¥­æ™‚é–“ï¼š9:00-17:00ï¼ˆå­£ç¯€ã«ã‚ˆã‚Šå¤‰å‹•ï¼‰</p>
        <p>â€» ç•‘ä½œæ¥­ã§ãŠé›»è©±ã«å‡ºã‚‰ã‚Œãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ãƒ¡ãƒ¼ãƒ«ã§ã®ã”é€£çµ¡ãŒç¢ºå®Ÿã§ã™ã€‚</p>
        <p><a href="law.html">ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜</a> ï¼ <a href="privacy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></p>
      </div>
      <div class="copyright">Â© 2025 ãªãŒãŸã¶ã©ã†åœ’</div>
    </div>
  </footer>

  <!-- ===== Base Scripts ===== -->
  <script src="assets/js/main.js"></script>
  <script>
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼†ãƒ’ãƒ¼ãƒ­ãƒ¼åŒæœŸ
    (async () => {
      try {
        const res = await fetch('assets/data/status.json', { cache: 'no-store' });
        const data = await res.json();
        const map = { preorder: 'äºˆç´„å—ä»˜å‰', inseason: 'å—ä»˜ä¸­', ended: 'ä»Šå­£çµ‚äº†' };
        document.getElementById('statusMode').textContent = map[data.mode] || 'å—ä»˜çŠ¶æ³';
        document.getElementById('statusMsg').textContent  = data.message || '';
        if (data.ship_eta) document.getElementById('shipEta').textContent = data.ship_eta;
        if (data.notice_url) document.getElementById('statusLink').href = data.notice_url;
        document.getElementById('heroMode').textContent = map[data.mode] || 'å—ä»˜çŠ¶æ³';
      } catch(e) {/* silent */}
    })();
  </script>

  <!-- ===== GASç‰ˆ ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ—¢å­˜ã¨åŒã˜ã€å¤‰æ›´ãªã—ï¼‰ ===== -->
  <script>
    let CFG = {};
    try { CFG = JSON.parse(document.getElementById('cfg-json').textContent || '{}'); } catch(_) { CFG = {}; }
    const API_BASE = CFG.webAppUrl || 'https://script.google.com/macros/s/XXXXX/exec';
    document.getElementById('ship').textContent = ((CFG.shippingFee || 0) >>> 0).toLocaleString();

    const state = { products: [], cart: [] };

    const yen = (n)=> (n||0).toLocaleString();
    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 2200);
    }
    const calcPricePerBox = (p)=> Math.round((Number(p['gå˜ä¾¡'])||0) * (Number(p['åŸºæº–é‡é‡g'])||0));

    function updateCartBadge(){
      const n = state.cart.reduce((a,b)=> a + (Number(b.æ•°é‡)||0), 0);
      ['cartCountHead', 'cartCountSticky'].forEach(id=>{
        const el = document.getElementById(id); if(!el) return;
        el.textContent = n;
        el.animate([{transform:'scale(1)'},{transform:'scale(1.25)'},{transform:'scale(1)'}],{duration:300,easing:'ease-out'});
      });
    }

    function attachPressEffects(scope = document) {
      const targets = scope.querySelectorAll('#shopApp button, #shopApp .btn, #shopApp .cart-sticky, #shopApp .cart-sticky__cta');
      targets.forEach(el => {
        if (el.classList.contains('pressable')) return;
        el.classList.add('pressable');
        let pressed = false;
        const down = () => { pressed = true; el.classList.add('is-pressed'); };
        const up   = () => { if(!pressed) return; pressed = false; el.classList.remove('is-pressed'); };
        el.addEventListener('pointerdown', down, { passive:true });
        ['pointerup','pointerleave','pointercancel','blur'].forEach(ev=> el.addEventListener(ev, up, { passive:true }));
        el.addEventListener('keydown', e=>{ if(e.code==='Space'||e.code==='Enter') down(); });
        el.addEventListener('keyup',   e=>{ if(e.code==='Space'||e.code==='Enter') up(); });
      });
    }

    function showSkeletons(n = 6){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      for (let i = 0; i < n; i++){
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="sk-image" style="height:200px;background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:sk 1.2s linear infinite;"></div>
          <div style="padding:12px">
            <div class="sk-line" style="height:14px;margin:10px 0;width:80%;background:#eee;"></div>
            <div class="sk-line" style="height:12px;margin:8px 0;width:60%;background:#f0f0f0;"></div>
            <div class="sk-line" style="height:12px;margin:8px 0;width:90%;background:#f0f0f0;"></div>
          </div>`;
        grid.appendChild(card);
      }
      attachPressEffects(grid);
    }

    function renderProducts(){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      state.products.forEach(p=>{
        const stock   = Number(p['åœ¨åº«ç®±æ•°'])||0;
        const soldout = stock <= 0;

        const imgs = String(p['ç”»åƒURL']||'').split(',').map(s=>s.trim()).filter(Boolean);
        const images = imgs.length ? imgs : ['https://placehold.co/1200x900?text=No+Image'];

        const tags = String(p['ã‚¿ã‚°']||'').split(',').map(s=>s.trim()).filter(Boolean);
        const tagHtml = tags.map(t=>{
          const key = t.includes('æ–°') ? 'is-new' : t.includes('äººæ°—') ? 'is-hit' : t.includes('ä»Š') ? 'is-season' : '';
          return `<span class="badge-chip ${key}">${t}</span>`;
        }).join('');

        const card = document.createElement('div');
        card.className = 'card' + (soldout?' soldout':'');

        card.innerHTML = `
          <div class="media" style="position:relative">
            <div class="badges">${tagHtml}</div>
            <div class="carousel" tabindex="0" aria-label="å•†å“ç”»åƒ">
              ${images.map(src => `<img loading="lazy" src="${src}" alt="${p['å•†å“å']}">`).join('')}
            </div>
            <div class="carousel-dots">
              ${images.map((_,i)=>`<span class="carousel-dot ${i===0?'is-active':''}"></span>`).join('')}
            </div>
          </div>

          <div class="body">
            <div class="name">${p['å•†å“å']}</div>
            <div class="meta">åŸºæº–é‡é‡: ${p['åŸºæº–é‡é‡g']}gï¼ˆç›®å®‰: ${p['é‡é‡ç›®å®‰']||'-'}ï¼‰</div>
            <div class="meta">ä¾¡æ ¼/ç®±: Â¥${(Math.round((+p['gå˜ä¾¡']||0) * (+p['åŸºæº–é‡é‡g']||0))).toLocaleString()}</div>
            <div class="meta">åœ¨åº«: ${stock} ç®±</div>

            <div class="row">
              <div class="qty">
                <select class="qty-select">
                  ${Array.from({length: Math.max(0, Math.min(stock, 20))}, (_,i)=>`<option value="${i+1}">${i+1}</option>`).join('') || '<option value="0">0</option>'}
                </select>
              </div>
              <button class="btn btn--wide" ${soldout?'disabled':''}>ã‚«ãƒ¼ãƒˆã«è¿½åŠ </button>
            </div>
          </div>
        `;

        const rail = card.querySelector('.carousel');
        const dots = [...card.querySelectorAll('.carousel-dot')];
        rail?.addEventListener('scroll', ()=>{
          const idx = Math.round(rail.scrollLeft / rail.clientWidth);
          dots.forEach((d,i)=> d.classList.toggle('is-active', i===idx));
        }, {passive:true});

        const qtySelect = card.querySelector('.qty-select');
        card.querySelector('.btn')?.addEventListener('click', ()=>{
          const q = Number(qtySelect?.value)||1;
          if (q <= 0 || soldout) return;
          addToCart(p, q);
          toast('ã‚«ãƒ¼ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ');
        });

        grid.appendChild(card);
      });

      attachPressEffects(grid);
    }

    function addToCart(product, qty){
      const id = product['å•†å“ID'];
      const exist = state.cart.find(x=> x.å•†å“ID === id);
      if (exist) exist.æ•°é‡ += qty;
      else state.cart.push({ å•†å“ID:id, å•†å“å:product['å•†å“å'], å˜ä¾¡:calcPricePerBox(product), åŸºæº–é‡é‡g:product['åŸºæº–é‡é‡g'], æ•°é‡:qty });
      updateCartBadge();
    }

    function openCheckoutModal(){
      __lockBodyScroll();
      renderCartTableInModal();
      document.getElementById('checkoutOverlay').style.display = 'block';
      document.getElementById('checkoutModal').style.display = 'block';
      setTimeout(()=> document.getElementById('m-name').focus(), 50);
    }
    function closeCheckoutModal(){
      document.getElementById('checkoutOverlay').style.display = 'none';
      document.getElementById('checkoutModal').style.display = 'none';
      __unlockBodyScroll();
    }
    document.getElementById('m-close').addEventListener('click', closeCheckoutModal);
    document.getElementById('m-back').addEventListener('click', closeCheckoutModal);
    document.getElementById('openCart')?.addEventListener('click', openCheckoutModal);
    document.getElementById('stickyCart')?.addEventListener('click', openCheckoutModal);

    function renderCartTableInModal(){
      const tbody = document.querySelector('#modalCartTable tbody'); tbody.innerHTML = '';
      let subtotal = 0;
      (state.cart||[]).forEach(it=>{
        const line = it.å˜ä¾¡ * it.æ•°é‡; subtotal += line;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.å•†å“å}</td>
          <td><input type="number" min="1" value="${it.æ•°é‡}" style="width:80px"></td>
          <td>Â¥${yen(line)}</td>
          <td><button class="btn" data-remove>å‰Šé™¤</button></td>`;
        tr.querySelector('input').addEventListener('change', (e)=>{
          it.æ•°é‡ = Math.max(1, Number(e.target.value)||1);
          renderCartTableInModal(); updateCartBadge();
        });
        tr.querySelector('[data-remove]').addEventListener('click', ()=>{
          const i = state.cart.findIndex(x=> x.å•†å“ID === it.å•†å“ID);
          if(i>=0){ state.cart.splice(i,1); renderCartTableInModal(); updateCartBadge(); }
        });
        tbody.appendChild(tr);
      });
      document.getElementById('m-subtotal').textContent = yen(subtotal);
      const baseShip = CFG.shippingFee||0;
      document.getElementById('m-shipping').textContent = yen(baseShip);
      document.getElementById('m-total').textContent = yen(subtotal + baseShip);
    }

    async function submitOrderFromModal(){
      if((state.cart||[]).length === 0){ alert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™'); return; }
      const btn = document.getElementById('m-submit');
      const orig = btn.textContent; btn.disabled = true; btn.textContent = 'é€ä¿¡ä¸­...';
      try {
        const payload = {
          items: state.cart.map(({å•†å“ID, æ•°é‡})=> ({å•†å“ID, æ•°é‡})),
          customer: {
            æ°å:  document.getElementById('m-name').value.trim(),
            ãƒ¡ãƒ¼ãƒ«: document.getElementById('m-email').value.trim(),
            é›»è©±:  document.getElementById('m-tel').value.trim(),
            ä½æ‰€:  document.getElementById('m-addr').value.trim(),
            å‚™è€ƒ:  document.getElementById('m-note').value.trim(),
            æ”¯æ‰•æ–¹æ³•: document.getElementById('m-pay').value
          },
          é€æ–™: CFG.shippingFee||0
        };
        let errors = [];
        if(!payload.customer.æ°å) errors.push("æ°å");
        if(!payload.customer.ä½æ‰€) errors.push("ä½æ‰€");
        if(!payload.customer.ãƒ¡ãƒ¼ãƒ« && !payload.customer.é›»è©±) errors.push("ãƒ¡ãƒ¼ãƒ«ã¾ãŸã¯é›»è©±ç•ªå·");
        if(errors.length){ showThanks("âŒ " + errors.join("ãƒ»") + " ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“"); btn.disabled=false; btn.textContent=orig; return; }

        const res = await fetch(`${API_BASE}?api=order`, { method:'POST', body: JSON.stringify(payload) });
        const data = await res.json();
        if(!data.ok){ showThanks("âŒ ã‚¨ãƒ©ãƒ¼: " + (data.error||'é€ä¿¡å¤±æ•—')); btn.disabled=false; btn.textContent=orig; return; }

        state.cart = []; updateCartBadge(); closeCheckoutModal();
        showThanks(`âœ… ã”æ³¨æ–‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼<br>æ³¨æ–‡ç•ªå·ï¼š<b>${data.orderId}</b><br>åˆè¨ˆï¼šÂ¥${(data.total||0).toLocaleString()}`);
      } catch(e){
        console.error(e); showThanks("âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼");
      } finally {
        btn.disabled=false; btn.textContent=orig;
      }
    }
    document.getElementById('m-submit').addEventListener('click', submitOrderFromModal);

    function showThanks(html){
      const ov = document.createElement('div');
      ov.className = 'modal-overlay'; ov.style.display='block'; ov.style.zIndex=9998;
      const box = document.createElement('div');
      box.className='modal'; box.style.display='block';
      box.innerHTML = `
        <div style="padding:6px 0;text-align:center;">${html}</div>
        <div class="actions" style="justify-content:center">
          <button class="btn" id="t-ok">é–‰ã˜ã‚‹</button>
        </div>`;
      document.body.appendChild(ov); document.body.appendChild(box);
      document.getElementById('t-ok').addEventListener('click', ()=>{ box.remove(); ov.remove(); });
    }

    (function(){
      const isiOS = /iP(hone|ad|od)/.test(navigator.userAgent);
      let savedScrollY = 0;
      window.__lockBodyScroll = function(){
        savedScrollY = window.scrollY || document.documentElement.scrollTop;
        document.body.style.position = 'fixed';
        document.body.style.top = `-${savedScrollY}px`;
        document.body.style.left = '0'; document.body.style.right = '0'; document.body.style.width = '100%';
      };
      window.__unlockBodyScroll = function(){
        document.body.style.position = ''; document.body.style.top = ''; document.body.style.left = ''; document.body.style.right = ''; document.body.style.width = '';
        window.scrollTo(0, savedScrollY);
      };
      if (isiOS) {
        document.addEventListener('focusin', (e) => {
          if (!e.target.matches('input, textarea, select')) return;
          setTimeout(() => {
            e.target.scrollIntoView({ block: 'center', inline: 'nearest', behavior: 'smooth' });
          }, 50);
        });
      }
    })();

    function calcShippingFeeFront(addr){
      if(!addr) return CFG.shippingFee || 500;
      if(addr.includes("åŒ—æµ·é“")) return 1200;
      if(addr.includes("æ²–ç¸„")) return 1500;
      if(addr.includes("é›¢å³¶")) return 2000;
      return CFG.shippingFee || 500;
    }
    document.getElementById('m-addr').addEventListener('input', ()=>{
      const addr = document.getElementById('m-addr').value;
      const newFee = calcShippingFeeFront(addr);
      document.getElementById('m-shipping').textContent = newFee.toLocaleString();
      const subtotal = state.cart.reduce((sum,it)=> sum + it.å˜ä¾¡ * it.æ•°é‡, 0);
      document.getElementById('m-total').textContent = (subtotal + newFee).toLocaleString();
    });

    async function fetchProducts(){
      const res = await fetch(`${API_BASE}?api=products`, { cache: 'no-store' });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || "å•†å“å–å¾—å¤±æ•—");
      state.products = data.products || [];
      renderProducts();
    }

    updateCartBadge();
    showSkeletons(6);
    fetchProducts().catch(err=>{
      console.error(err);
      document.getElementById('grid').innerHTML = '<div class="card" style="padding:16px">å•†å“ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
    });

    attachPressEffects(document.getElementById('shopApp'));
  </script>
</body>
</html>
